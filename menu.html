<!DOCTYPE html>
<html lang="pt-BR">
<head>   
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Pro</title>
    
    <meta property="og:title" content="Listening Pro" />
    <meta property="og:type" content="lessons" />
    <meta property="og:url" content="https://www.meusite.com/pagina" />
    <meta property="og:image" content="https://www.meusite.com/imagens/miniatura.jpg" />
    <meta property="og:description" content="Descrição da página" />
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        html {
            background-color: #2b2e31;
            min-height: 100%;
        }
        
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #2b2e31;
            color: #f9fff2;
        }
        
        .palavra {
            display: inline-block;
            margin: 5px;
            padding: 10px;
            border: 1px solid #a5b68f;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
            background-color: #f9fff2;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .errada {
            background-color: #ff6666 !important;
            transition: background-color 0.5s;
        }
        
        .acertada {
            background-color: #90ee90;
            transition: background-color 0.5s;
        }
        
        .palavra:hover {
            background-color: #eef5e7;
        }
        
        .frase {
            font-size: 24px;
            margin-bottom: 20px;
            min-height: 60px;
            border: 1px dashed #a5b68f;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            word-break: break-word;
            background-color: #f9fff2;
            color: #333;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .palavra-na-frase {
            margin-right: 8px;
        }
        
        #botoes {
            margin-top: 20px;
            text-align: center;
        }
        
        #botao-avancar {
            margin-top: 15px;
            text-align: center;
        }
        
        .info-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        #progresso {
            font-size: 18px;
            font-weight: bold;
            text-align: right;            
            color: #f9fff2;
        }
        
        #placar {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
            text-align: left;
        }
        
        #video-container {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            background-color: #000;
        }
        
        #custom-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        button {
            padding: 10px 15px;
            background: linear-gradient(to bottom, #5cbc5c 0%, #4CAF50 50%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
        }
        
        button:hover {
            background: linear-gradient(to bottom, #6ad26a 0%, #5cbc5c 50%, #4CAF50 100%);
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            transform: translateY(-1px);
        }
        
        button:active {
            background: linear-gradient(to bottom, #45a049 0%, #4CAF50 50%, #5cbc5c 100%);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            transform: translateY(1px);
        }
        
        #avancar {
            background: linear-gradient(to bottom, #42a5f5 0%, #2196F3 50%, #0b7dda 100%);
            font-weight: bold;
            padding: 12px 20px;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        #avancar:hover {
            background: linear-gradient(to bottom, #64b5f6 0%, #42a5f5 50%, #2196F3 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.25);
        }
        
        #avancar:active {
            background: linear-gradient(to bottom, #0b7dda 0%, #2196F3 50%, #42a5f5 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Menu Button and Menu Styles - REDESIGNED */
        #menu-button {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px; /* Reduced size */
            height: 40px; /* Reduced size */
            border-radius: 8px; /* Square with rounded corners */
            background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); /* Mac-style gradient */
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: none;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            padding: 0;
        }
        
        #menu-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .menu-icon {
            width: 20px; /* Smaller icon */
            height: 2px;
            background-color: white;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .menu-icon:before, .menu-icon:after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background-color: white;
            transition: all 0.3s ease;
            left: 0;
        }
        
        .menu-icon:before {
            transform: translateY(-6px);
        }
        
        .menu-icon:after {
            transform: translateY(6px);
        }
        
        #menu-button.active .menu-icon {
            background-color: transparent;
        }
        
        #menu-button.active .menu-icon:before {
            transform: rotate(45deg);
        }
        
        #menu-button.active .menu-icon:after {
            transform: rotate(-45deg);
        }
        
        #menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            backdrop-filter: blur(8px);
        }
        
        #menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        #menu-items {
            width: 80%;
            max-width: 600px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 20px;
            background-color: #2b2e31;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            position: relative; /* For positioning the logout button */
        }
        
        /* Menu header with controls */
        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        /* User controls in menu */
        .menu-user-controls {
            display: flex;
            gap: 10px;
        }
        
        #menu-logout-btn {
            background: linear-gradient(to bottom, #ff7878 0%, #ff6666 50%, #e55c5c 100%);
            padding: 5px 10px;
            font-size: 14px;
            margin: 0;
        }
        
        #menu-change-password-btn {
            background: linear-gradient(to bottom, #78c0ff 0%, #5babf0 50%, #4d98e5 100%);
            padding: 5px 10px;
            font-size: 14px;
            margin: 0;
        }
        
        .menu-title {
            text-align: center;
            color: #f9fff2;
            font-size: 28px;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .lesson-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        .lesson-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 14px rgba(0,0,0,0.2);
        }
        
        .lesson-button:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            transform: translateX(-100%);
            transition: all 0.6s ease;
        }
        
        .lesson-button:hover:after {
            transform: translateX(100%);
        }
        
        .close-button {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            border: none;
        }
        
        .close-button:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }
        
        .close-icon {
            position: relative;
            width: 20px;
            height: 20px;
        }
        
        .close-icon:before, .close-icon:after {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background-color: white;
            top: 9px;
            left: 0;
        }
        
        .close-icon:before {
            transform: rotate(45deg);
        }
        
        .close-icon:after {
            transform: rotate(-45deg);
        }
        
        /* Loading Indicator */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        #loading.active {
            visibility: visible;
            opacity: 1;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Current lesson info */
        #current-lesson {
            text-align: center;
            color: #f9fff2;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
        }

        /* Login/Register Container */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #auth-box {
            background-color: #2b2e31;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .auth-title {
            text-align: center;
            color: #f9fff2;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative; /* For forgot password link positioning */
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #f9fff2;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #a5b68f;
            background-color: #f9fff2;
            font-size: 16px;
        }

        .forgot-password {
            display: block;
            text-align: left;
            margin-top: 5px;
            font-size: 14px;
            color: #64b5f6;
            text-decoration: none;
            cursor: pointer;
        }

        .forgot-password:hover {
            text-decoration: underline;
        }

        .auth-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .auth-message {
            color: #ff6666;
            text-align: center;
            margin-top: 10px;
            min-height: 40px;
        }

        .auth-message.success {
            color: #4CAF50;
        }

        /* User info display - REMOVED FROM MAIN SCREEN */
        #user-info {
            display: none; /* Hidden now that we moved to menu */
        }
        
        /* Reset Password Container */
        #reset-password-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 2001; /* Higher than auth container */
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
        }

        #reset-password-box {
            background-color: #2b2e31;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .reset-title {
            text-align: center;
            color: #f9fff2;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .reset-steps {
            display: flex;
            margin-bottom: 20px;
        }

        .reset-step {
            flex: 1;
            text-align: center;
            padding: 5px;
            color: #a5b68f;
            position: relative;
        }

        .reset-step.active {
            color: #4CAF50;
            font-weight: bold;
        }

        .reset-step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 10px;
            height: 2px;
            background-color: #a5b68f;
        }

        .reset-form {
            display: none; /* Hidden by default */
        }

        .reset-form.active {
            display: block;
        }

        .reset-message {
            color: #ff6666;
            text-align: center;
            margin-top: 10px;
            min-height: 40px;
        }

        .reset-message.success {
            color: #4CAF50;
        }

        .reset-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .reset-timer {
            text-align: center;
            color: #f9fff2;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .code-input {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        
        .code-input input {
            width: 40px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            border-radius: 5px;
            border: 1px solid #a5b68f;
            background-color: #f9fff2;
        }
        
        .back-button {
            background: linear-gradient(to bottom, #9e9e9e 0%, #757575 50%, #616161 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Auth Container -->
    <div id="auth-container">
        <div id="auth-box">
            <h2 class="auth-title">Bem-vindo ao Listening Pro</h2>
            <div id="login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Digite seu email">
                    <a href="#" class="forgot-password" id="forgot-password-link">Esqueceu sua senha?</a>
                </div>
                <div class="form-group">
                    <label for="password">Senha:</label>
                    <input type="password" id="password" placeholder="Digite sua senha">
                </div>
                <div class="auth-message" id="auth-message"></div>
                <div class="auth-buttons">
                    <button id="login-btn">Entrar</button>
                    <button id="register-btn">Registrar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Password Container -->
    <div id="reset-password-container">
        <div id="reset-password-box">
            <h2 class="reset-title">Recuperação de Senha</h2>
            
            <div class="reset-steps">
                <div class="reset-step step-1 active">1º Email ✉</div>
                <div class="reset-step step-2">2º Código ✎</div>
                <div class="reset-step step-3">3º Senha ✓</div>
            </div>
            
            <!-- Step 1: Email Input -->
            <div class="reset-form step-1-form active">
                <div class="form-group">
                    <label for="reset-email">Digite seu email:</label>
                    <input type="email" id="reset-email" placeholder="seu@email.com">
                </div>
                <div class="reset-message" id="reset-message-1"></div>
                <div class="reset-buttons">
                    <button class="back-button" id="reset-back-1">Cancelar</button>
                    <button id="reset-next-1">Enviar Código</button>
                </div>
            </div>
            
            <!-- Step 2: Code Verification -->
            <div class="reset-form step-2-form">
                <p>Um código de verificação foi enviado para seu email. Digite o código abaixo:</p>
                
                <div class="code-input">
                    <input type="text" maxlength="1" class="code-digit" id="code-1">
                    <input type="text" maxlength="1" class="code-digit" id="code-2">
                    <input type="text" maxlength="1" class="code-digit" id="code-3">
                    <input type="text" maxlength="1" class="code-digit" id="code-4">
                    <input type="text" maxlength="1" class="code-digit" id="code-5">
                    <input type="text" maxlength="1" class="code-digit" id="code-6">
                </div>
                
                <div class="reset-timer" id="reset-timer">Código válido por: 5:00</div>
                <div class="reset-message" id="reset-message-2"></div>
                <div class="reset-buttons">
                    <button class="back-button" id="reset-back-2">Voltar</button>
                    <button id="reset-next-2">Verificar</button>
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <a href="#" id="resend-code">Reenviar código</a>
                </div>
            </div>
            
            <!-- Step 3: New Password -->
            <div class="reset-form step-3-form">
                <div class="form-group">
                    <label for="new-password">Nova senha:</label>
                    <input type="password" id="new-password" placeholder="Digite sua nova senha">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirme a senha:</label>
                    <input type="password" id="confirm-password" placeholder="Confirme sua nova senha">
                </div>
                <div class="reset-message" id="reset-message-3"></div>
                <div class="reset-buttons">
                    <button class="back-button" id="reset-back-3">Voltar</button>
                    <button id="reset-finish">Alterar Senha</button>
                </div>
            </div>
        </div>
    </div>

    <div id="current-lesson">Selecione uma lição no menu</div>
    
    <div id="video-container">
        <video id="custom-video" controls>
            <source src="" type="video/mp4">
            Seu navegador não suporta vídeos HTML5.
        </video>
    </div>
    
    <div class="frase" id="frase"></div>
    <div id="palavras"></div>
    
    <div id="botoes">
        <button id="repetir" style="background: linear-gradient(to bottom, #ffc078 0%, #ffa94d 50%, #e59442 100%);">Tocar Trecho</button>
        <button id="lerFrase" style="background: linear-gradient(to bottom, #78c0ff 0%, #5babf0 50%, #4d98e5 100%);">Voz Sintetica</button>
        <button id="desistir" style="background: linear-gradient(to bottom, #ff7878 0%, #ff6666 50%, #e55c5c 100%);">Desistir</button>
    </div>
    
    <div id="botao-avancar">
        <button id="avancar" style="display: none;">Avançar</button>
    </div>
    
    <div class="info-container">
        <div id="placar">Acertos: 0</div>
        <div id="progresso">Progresso: 0 de 0</div>
    </div>
    
    <!-- Menu Button -->
    <button id="menu-button">
        <div class="menu-icon"></div>
    </button>
    
    <!-- Menu Overlay -->
    <div id="menu-overlay">
        <div id="menu-items">
            <!-- Menu header with controls -->
            <div class="menu-header">
                <div class="menu-user-controls">
                    <button id="menu-logout-btn">Sair</button>
                    <button id="menu-change-password-btn">Alterar Senha</button>
                </div>
                <button class="close-button" style="display:none">
    				<div class="close-icon"></div>
                </button>
            </div>
            
            <h2 class="menu-title">Lista de Lições</h2>
            <!-- Dynamic lesson buttons will be inserted here -->
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading">
        <div class="spinner"></div>
    </div>
    
    <script>
        // Aguardar o DOM estar pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Obter a URL atual para uso em redirecionamentos
            const currentUrl = window.location.href.split('?')[0]; // Remove qualquer parâmetro existente
            
            // Inicializar Supabase com suas credenciais
            const SUPABASE_URL = 'https://rnogpegpfzzhrxjxtxqn.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJub2dwZWdwZnp6aHJ4anh0eHFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDEyNTAsImV4cCI6MjA2MzI3NzI1MH0.TStNnAKgZBoYnxP-CZZEbChvE3FRlqJ5NruJbqWIGN0';
            
            // Verificar se o objeto Supabase está disponível
            if (typeof supabase === 'undefined') {
                console.error('Erro: Biblioteca Supabase não carregada corretamente');
                document.getElementById('auth-message').textContent = 'Erro ao carregar a biblioteca Supabase. Recarregue a página.';
                return;
            }
            
            // Criar cliente Supabase
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // Variáveis de autenticação
            let currentUser = null;
            
            // Variáveis para recuperação de senha
            let resetCode = null;
            let resetCodeExpiry = null;
            let resetEmail = null;
            let resetTimer = null;
            let resetCodeCreationInProgress = false;
            let resetCodeSubscription = null;

            // Lições disponíveis (nome do arquivo SRT e URL do vídeo)
            const lessons = [
                { 
                    name: "Lady Gaga - Scheiße",
                    srtFile: "Lady Gaga - Scheiße.srt",
                    videoUrl: "https://files.catbox.moe/noor8m.mp4"
                },
                { 
                    name: "Melanie Martinez - The Contortionist",
                    srtFile: "Melanie Martinez - The Contortionist.srt",
                    videoUrl: "https://files.catbox.moe/vxoldg.mp4" 
                },
                { 
                    name: "New West - Those Eyes",
                    srtFile: "New West - Those Eyes.srt",
                    videoUrl: "https://files.catbox.moe/k7xhth.mp4" 
                }
                // Adicione mais lições conforme necessário
            ];
            
            // Variáveis globais
            let videoElement = document.getElementById('custom-video');
            let frases = [];
            let indiceFrase = 0;
            let fraseAtual = null;
            let palavrasEmbaralhadas = [];
            let palavrasClicadas = [];
            let palavraElementos = {};
            let progresso = 0;
            let acertos = 0;
            let playerReady = false;
            let monitorTempoId;
            let fraseAcertada = false;
            let audioPlaying = false;
            let currentLessonName = "";
            let currentLessonIndex = -1;
            
            // Função para gerar o URL do CDN do jsDelivr para os arquivos SRT
            function getSrtCdnUrl(filename) {
                // URL base do jsDelivr para o seu repositório
                const baseUrl = "https://cdn.jsdelivr.net/gh/CrisClei2022/listeningpro@main/";
                // Retorna a URL completa
                return baseUrl + encodeURIComponent(filename);
            }
            
            // Função para carregar o arquivo SRT de uma URL
            async function loadSrtFromUrl(url) {
                try {
                    showLoading(true);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to load SRT: ${response.status}`);
                    }
                    const srtContent = await response.text();
                    processSrtContent(srtContent);
                    showLoading(false);
                    return true;
                } catch (error) {
                    console.error("Error loading SRT:", error);
                    alert("Erro ao carregar o arquivo de legendas. Por favor, tente novamente.");
                    showLoading(false);
                    return false;
                }
            }
            
            // Função para processar o conteúdo SRT
            function processSrtContent(srt) {
                frases = srt.split('\n\n').map(bloco => {
                    let linhas = bloco.split('\n');
                    if (linhas.length < 3) return null;
                    
                    return {
                        tempoInicio: converterTempo(linhas[1].split(' --> ')[0].trim()),
                        tempoFim: converterTempo(linhas[1].split(' --> ')[1].trim()),
                        texto: linhas.slice(2).join(' ').trim()
                    };
                }).filter(frase => frase !== null && frase.texto !== '' && !frase.texto.includes('www.RentAnAdviser.com'));
                
                indiceFrase = 0;
                fraseAtual = frases[indiceFrase];
                palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
                palavrasClicadas = [];
                progresso = 0;
                acertos = 0;
                fraseAcertada = false;
                
                criarPalavras();
                atualizarFrase();
                atualizarProgresso();
                atualizarPlacar();
                document.getElementById('avancar').style.display = 'none';
            }
            
            // Função para carregar uma lição
            async function loadLesson(lessonIndex) {
                // Salvar progresso da lição atual antes de mudar
                if (currentUser && currentLessonName && indiceFrase > 0) {
                    await salvarProgressoDoServidor(currentLessonName, indiceFrase, acertos);
                }
                
                currentLessonIndex = lessonIndex;
                const lesson = lessons[lessonIndex];
                currentLessonName = lesson.name;
                
                // Atualizar o título da lição atual
                document.getElementById('current-lesson').textContent = currentLessonName;
                
                // Configurar o vídeo
                videoElement.src = lesson.videoUrl;
                videoElement.load();
                
                // Carregar o arquivo SRT
                const srtUrl = getSrtCdnUrl(lesson.srtFile);
                const success = await loadSrtFromUrl(srtUrl);
                
                if (success && currentUser) {
                    // Salvar a última lição acessada
                    salvarUltimaLicao(lessonIndex);
                    
                    // Verificar se há progresso salvo para esta lição
                    const progresso = await carregarProgressoDoServidor(currentLessonName);
                    if (progresso) {
                        const confirmarContinuar = confirm(`Você já iniciou esta lição antes. Deseja continuar de onde parou? (Frase ${progresso.fraseIndex + 1} de ${frases.length})`);
                        if (confirmarContinuar) {
                            // Carregar o progresso salvo
                            indiceFrase = progresso.fraseIndex;
                            acertos = progresso.acertos;
                            fraseAtual = frases[indiceFrase];
                            palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
                            palavrasClicadas = [];
                            fraseAcertada = false;
                            
                            criarPalavras();
                            atualizarFrase();
                            atualizarProgresso();
                            atualizarPlacar();
                            document.getElementById('avancar').style.display = 'none';
                        }
                    }
                }
                
                // Fechar o menu
                toggleMenu();
            }
            
            // Função para converter tempo do formato SRT para segundos
            function converterTempo(tempo) {
                let partes = tempo.split(':');
                let segundos = parseFloat(partes[2].replace(',', '.'));
                segundos += parseInt(partes[1]) * 60;
                segundos += parseInt(partes[0]) * 3600;
                return segundos;
            }
            
            // Função para iniciar o monitoramento do tempo do vídeo
            function iniciarMonitorTempo() {
                pararMonitorTempo(); // Parar qualquer monitoramento anterior
                
                monitorTempoId = setInterval(() => {
                    if (videoElement.paused) {
                        pararMonitorTempo();
                        return;
                    }
                    
                    if (videoElement.currentTime >= fraseAtual.tempoFim) {
                        videoElement.pause();
                        pararMonitorTempo();
                    }
                }, 100);
            }
            
            // Função para parar o monitoramento do tempo do vídeo
            function pararMonitorTempo() {
                if (monitorTempoId) {
                    clearInterval(monitorTempoId);
                    monitorTempoId = null;
                }
            }
            
            // Função para mostrar ou esconder o indicador de carregamento
            function showLoading(show) {
                const loadingElement = document.getElementById('loading');
                if (show) {
                    loadingElement.classList.add('active');
                } else {
                    loadingElement.classList.remove('active');
                }
            }
            
            // Função para mostrar o container de recuperação de senha
            function showResetPasswordContainer(step) {
                // Esconder todas as etapas
                document.querySelectorAll('.reset-form').forEach(form => {
                    form.classList.remove('active');
                });
                
                // Remover a classe active de todas as etapas
                document.querySelectorAll('.reset-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });
                
                // Mostrar a etapa atual
                document.querySelector(`.step-${step}-form`).classList.add('active');
                document.querySelector(`.step-${step}`).classList.add('active');
                
                // Mostrar o container
                document.getElementById('reset-password-container').style.display = 'flex';
            }
            
            // Função para esconder o container de recuperação de senha
            function hideResetPasswordContainer() {
                document.getElementById('reset-password-container').style.display = 'none';
                
                // Limpar mensagens
                document.getElementById('reset-message-1').textContent = "";
                document.getElementById('reset-message-2').textContent = "";
                document.getElementById('reset-message-3').textContent = "";
                
                // Parar o timer
                if (resetTimer) {
                    clearInterval(resetTimer);
                    resetTimer = null;
                }
                
                // Cancelar a inscrição de realtime se existir
                if (resetCodeSubscription) {
                    resetCodeSubscription.unsubscribe();
                    resetCodeSubscription = null;
                }
            }
            
            /**
             * Função para disparar a criação de um código de recuperação no Supabase
             * Esta função apenas envia o comando para criar o código, sem aguardar o retorno
             * @param {string} email - Email do usuário para o qual o código será gerado
             * @returns {Promise<boolean>} - Retorna true se o comando foi enviado com sucesso, false caso contrário
             */
            async function requestResetCode(email) {
                try {
                    // Marcar que uma solicitação está em andamento
                    resetCodeCreationInProgress = true;
                    
                    // Calcular a data de expiração (5 minutos a partir de agora)
                    const expiryDate = new Date();
                    expiryDate.setMinutes(expiryDate.getMinutes() + 5);
                    
                    // Gerar um código aleatório
                    const code = generateResetCode();
                    
                    // Enviar o comando para o Supabase criar o código
                    // Não aguardamos o retorno aqui, apenas enviamos o comando
                    supabaseClient
                        .from('reset_codes')
                        .insert({
                            email: email,
                            code: code,
                            expires_at: expiryDate.toISOString(),
                            used: false
                        })
                        .then(({ data, error }) => {
                            if (error) {
                                console.error("Erro ao solicitar código de recuperação:", error);
                                resetCodeCreationInProgress = false;
                                return;
                            }
                            
                            console.log("Comando para criar código enviado com sucesso");
                        });
                    
                    // Armazenar o email para uso posterior
                    resetEmail = email;
                    
                    return true;
                } catch (error) {
                    console.error("Erro ao solicitar código de recuperação:", error);
                    resetCodeCreationInProgress = false;
                    return false;
                }
            }
            
            /**
             * Função para iniciar a escuta de eventos de criação de código
             * Esta função configura um listener para notificações do Supabase
             * @param {string} email - Email do usuário para o qual estamos aguardando o código
             * @returns {Promise<void>}
             */
            async function listenForResetCodeCreation(email) {
                // Cancelar qualquer inscrição anterior
                if (resetCodeSubscription) {
                    resetCodeSubscription.unsubscribe();
                }
                
                // Inscrever-se para receber atualizações da tabela reset_codes
                resetCodeSubscription = supabaseClient
                    .channel('reset_codes_channel')
                    .on('postgres_changes', 
                        { 
                            event: 'INSERT', 
                            schema: 'public', 
                            table: 'reset_codes',
                            filter: `email=eq.${email}`
                        }, 
                        (payload) => {
                            // Código foi criado no Supabase
                            console.log("Código de recuperação criado:", payload);
                            
                            // Atualizar a interface para mostrar que o código foi gerado
                            const messageElement = document.getElementById('reset-message-1');
                            messageElement.textContent = "Código gerado";
                            messageElement.className = "reset-message success";
                            
                            // Armazenar o código e a data de expiração
                            resetCode = payload.new.code;
                            resetCodeExpiry = new Date(payload.new.expires_at);
                            resetCodeCreationInProgress = false;
                            
                            // Simular um pequeno atraso antes de prosseguir
                            setTimeout(() => {
                                // Para fins de demonstração, mostrar o código na tela
                                messageElement.textContent = `Código de recuperação enviado! (Para demonstração, o código é: ${resetCode})`;
                                
                                // Avançar para a próxima etapa
                                showResetPasswordContainer(2);
                                
                                // Iniciar o timer
                                startResetCodeTimer();
                                
                                // Focar no primeiro campo do código
                                document.getElementById('code-1').focus();
                            }, 1000);
                        })
                    .subscribe();
            }
            
            // Função para verificar um código de recuperação
            async function verifyResetCode(email, code) {
                try {
                    // Verificar se o código existe e é válido
                    const { data, error } = await supabaseClient
                        .from('reset_codes')
                        .select('*')
                        .eq('email', email)
                        .eq('code', code)
                        .eq('used', false)
                        .gt('expires_at', new Date().toISOString())
                        .order('created_at', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error("Erro ao verificar código de recuperação:", error);
                        return false;
                    }
                    
                    if (!data || data.length === 0) {
                        return false;
                    }
                    
                    // Marcar o código como usado
                    await supabaseClient
                        .from('reset_codes')
                        .update({ used: true })
                        .eq('id', data[0].id);
                    
                    return true;
                } catch (error) {
                    console.error("Erro ao verificar código de recuperação:", error);
                    return false;
                }
            }
            
            // Função para iniciar o timer do código de recuperação
            function startResetCodeTimer() {
                // Parar qualquer timer existente
                if (resetTimer) {
                    clearInterval(resetTimer);
                    resetTimer = null;
                }
                
                // Calcular o tempo restante em segundos
                const now = new Date();
                const expiryTime = resetCodeExpiry || new Date(now.getTime() + 5 * 60 * 1000);
                let timeLeft = Math.max(0, Math.floor((expiryTime - now) / 1000));
                
                // Atualizar o elemento do timer
                const timerElement = document.getElementById('reset-timer');
                
                // Formatar o tempo inicial
                const initialMinutes = Math.floor(timeLeft / 60);
                const initialSeconds = timeLeft % 60;
                timerElement.textContent = `Código válido por: ${initialMinutes}:${initialSeconds < 10 ? '0' : ''}${initialSeconds}`;
                timerElement.style.color = '#f9fff2';
                
                // Atualizar o timer a cada segundo
                resetTimer = setInterval(() => {
                    timeLeft--;
                    
                    // Formatar o tempo restante
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `Código válido por: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                    
                    // Se o tempo acabou, parar o timer
                    if (timeLeft <= 0) {
                        clearInterval(resetTimer);
                        timerElement.textContent = 'Código expirado. Por favor, solicite um novo código.';
                        timerElement.style.color = '#ff6666';
                    }
                }, 1000);
            }
            
            // Função para salvar a última lição acessada no Supabase
            async function salvarUltimaLicao(lessonIndex) {
                if (!currentUser) return;
                
                try {
                    // Verificar se o usuário já tem um registro de preferência
                    const { data, error } = await supabaseClient
                        .from('user_preferences')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') {
                        // Erro diferente de "não encontrado"
                        throw error;
                    }
                    
                    if (data) {
                        // Atualizar registro existente
                        await supabaseClient
                            .from('user_preferences')
                            .update({
                                last_lesson_index: lessonIndex,
                                last_lesson_name: lessons[lessonIndex].name,
                                updated_at: new Date()
                            })
                            .eq('user_id', currentUser.id);
                    } else {
                        // Criar novo registro
                        await supabaseClient
                            .from('user_preferences')
                            .insert({
                                user_id: currentUser.id,
                                last_lesson_index: lessonIndex,
                                last_lesson_name: lessons[lessonIndex].name
                            });
                    }
                    
                    console.log("Última lição salva com sucesso");
                } catch (error) {
                    console.error("Erro ao salvar última lição:", error);
                }
            }

            // Função para carregar a última lição acessada do Supabase
            async function carregarUltimaLicaoDoServidor() {
                if (!currentUser) return null;
                
                try {
                    const { data, error } = await supabaseClient
                        .from('user_preferences')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // Registro não encontrado
                            return null;
                        }
                        throw error;
                    }
                    
                    if (data && data.last_lesson_index !== undefined && lessons[data.last_lesson_index]) {
                        const carregarUltimaLicao = confirm(`Deseja carregar a última lição acessada? (${lessons[data.last_lesson_index].name})`);
                        if (carregarUltimaLicao) {
                            loadLesson(data.last_lesson_index);
                        }
                    }
                } catch (error) {
                    console.error("Erro ao carregar última lição:", error);
                }
            }

            // Função para salvar progresso de uma lição específica no Supabase
            async function salvarProgressoDoServidor(lessonName, fraseIndex, acertos) {
                if (!currentUser) return;
                
                try {
                    // Verificar se há progresso existente para esta lição
                    const { data, error } = await supabaseClient
                        .from('lesson_progress')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('lesson_name', lessonName)
                        .single();
                    
                    if (error && error.code !== 'PGRST116') {
                        // Erro diferente de "não encontrado"
                        throw error;
                    }
                    
                    if (data) {
                        // Atualizar registro existente
                        await supabaseClient
                            .from('lesson_progress')
                            .update({
                                frase_index: fraseIndex,
                                acertos: acertos,
                                total_frases: frases.length,
                                updated_at: new Date()
                            })
                            .eq('id', data.id);
                    } else {
                        // Criar novo registro
                        await supabaseClient
                            .from('lesson_progress')
                            .insert({
                                user_id: currentUser.id,
                                lesson_name: lessonName,
                                frase_index: fraseIndex,
                                acertos: acertos,
                                total_frases: frases.length
                            });
                    }
                    
                    console.log("Progresso salvo com sucesso");
                } catch (error) {
                    console.error("Erro ao salvar progresso:", error);
                }
            }

            // Função para carregar progresso de uma lição específica do Supabase
            async function carregarProgressoDoServidor(lessonName) {
                if (!currentUser) return null;
                
                try {
                    const { data, error } = await supabaseClient
                        .from('lesson_progress')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('lesson_name', lessonName)
                        .single();
                    
                    if (error) {
                        if (error.code === 'PGRST116') {
                            // Registro não encontrado
                            return null;
                        }
                        throw error;
                    }
                    
                    if (data) {
                        return {
                            fraseIndex: data.frase_index,
                            acertos: data.acertos,
                            timestamp: data.updated_at
                        };
                    }
                    
                    return null;
                } catch (error) {
                    console.error("Erro ao carregar progresso:", error);
                    return null;
                }
            }

            // Função para auto-salvar progresso periodicamente
            function autoSaveProgress() {
                if (!currentUser || !currentLessonName) return;
                
                // Salvar progresso a cada minuto
                setInterval(() => {
                    if (currentUser && currentLessonName && indiceFrase > 0) {
                        salvarProgressoDoServidor(currentLessonName, indiceFrase, acertos);
                    }
                }, 60000); // 60 segundos
            }

            // Verificar se o usuário já está logado
            async function checkCurrentUser() {
                const { data, error } = await supabaseClient.auth.getSession();
                
                if (error) {
                    console.error("Error checking session:", error);
                    return false;
                }
                
                if (data.session) {
                    currentUser = data.session.user;
                    // Usuário já está logado, esconder tela de login
                    document.getElementById('auth-container').style.display = 'none';
                    return true;
                } else {
                    // Usuário não está logado, mostrar tela de login
                    document.getElementById('auth-container').style.display = 'flex';
                    return false;
                }
            }

            // Adicionar event listeners para botões de login e registro
            document.getElementById('login-btn').addEventListener('click', async function() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    document.getElementById('auth-message').textContent = "Por favor, preencha todos os campos!";
                    return;
                }
                
                const success = await logIn(email, password);
                if (success && currentUser) {
                    carregarUltimaLicaoDoServidor();
                    autoSaveProgress();
                }
            });

            document.getElementById('register-btn').addEventListener('click', async function() {
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                
                if (!email || !password) {
                    document.getElementById('auth-message').textContent = "Por favor, preencha todos os campos!";
                    return;
                }
                
                if (password.length < 6) {
                    document.getElementById('auth-message').textContent = "A senha deve ter pelo menos 6 caracteres.";
                    return;
                }
                
                console.log("Botão de registro clicado para:", email);
                await signUp(email, password);
            });

            // Adicionar event listener para o link "Esqueceu sua senha?"
            document.getElementById('forgot-password-link').addEventListener('click', function(e) {
                e.preventDefault();
                
                // Pegar o email do campo de login
                const email = document.getElementById('email').value;
                if (email) {
                    document.getElementById('reset-email').value = email;
                }
                
                // Mostrar o container de recuperação de senha
                showResetPasswordContainer(1);
            });

            // Adicionar event listener para o botão "Sair" no menu
            document.getElementById('menu-logout-btn').addEventListener('click', function() {
                logOut();
            });

            // Adicionar event listener para o botão "Alterar Senha" no menu
            document.getElementById('menu-change-password-btn').addEventListener('click', function() {
                if (!currentUser) {
                    alert("Você precisa estar logado para alterar a senha.");
                    return;
                }
                
                // Preencher o email do usuário atual
                document.getElementById('reset-email').value = currentUser.email;
                
                // Mostrar o container de recuperação de senha
                showResetPasswordContainer(1);
            });
            
            // Event listeners para os botões do fluxo de recuperação de senha
            document.getElementById('reset-back-1').addEventListener('click', function() {
                hideResetPasswordContainer();
            });
            
            document.getElementById('reset-next-1').addEventListener('click', async function() {
                const email = document.getElementById('reset-email').value;
                const messageElement = document.getElementById('reset-message-1');
                
                if (!email) {
                    messageElement.textContent = "Por favor, digite seu email.";
                    return;
                }
                
                // Verificar se o email existe
                messageElement.textContent = "Localizando cadastro...";
                messageElement.className = "reset-message";
                
                // Simular um pequeno atraso para mostrar a mensagem de "Localizando cadastro..."
                setTimeout(async () => {
                    const emailExists = await checkEmailExists(email);
                    
                    if (!emailExists) {
                        messageElement.textContent = "Email não encontrado. Por favor, verifique e tente novamente.";
                        messageElement.className = "reset-message";
                        return;
                    }
                    
                    // Mostrar mensagem de "Cadastro localizado"
                    messageElement.textContent = "Cadastro localizado";
                    messageElement.className = "reset-message success";
                    
                    // Simular um pequeno atraso antes de prosseguir
                    setTimeout(async () => {
                        // Verificar se já foi enviado um código nos últimos 5 minutos
                        const { data, error } = await supabaseClient
                            .from('reset_codes')
                            .select('*')
                            .eq('email', email)
                            .eq('used', false)
                            .gt('expires_at', new Date().toISOString())
                            .order('created_at', { ascending: false })
                            .limit(1);
                        
                        if (data && data.length > 0) {
                            const lastCodeTime = new Date(data[0].created_at);
                            const timeDiff = (new Date() - lastCodeTime) / 1000 / 60; // em minutos
                            
                            if (timeDiff < 5) {
                                messageElement.textContent = `Um código já foi enviado recentemente. Por favor, aguarde ${Math.ceil(5 - timeDiff)} minutos antes de solicitar um novo código.`;
                                messageElement.className = "reset-message";
                                return;
                            }
                        }
                        
                        // Iniciar a escuta de eventos de criação de código
                        await listenForResetCodeCreation(email);
                        
                        // Disparar a criação do código
                        messageElement.textContent = "Gerando código de recuperação...";
                        messageElement.className = "reset-message";
                        
                        const requestSent = await requestResetCode(email);
                        
                        if (!requestSent) {
                            messageElement.textContent = "Erro ao solicitar código de recuperação. Por favor, tente novamente.";
                            messageElement.className = "reset-message";
                            return;
                        }
                        
                        // A partir daqui, o listener configurado em listenForResetCodeCreation
                        // irá atualizar a interface quando o código for criado
                    }, 1000); // Aguardar 1 segundo após mostrar "Cadastro localizado"
                }, 1000); // Aguardar 1 segundo para simular a busca
            });
            
            document.getElementById('reset-back-2').addEventListener('click', function() {
                showResetPasswordContainer(1);
                
                // Parar o timer
                if (resetTimer) {
                    clearInterval(resetTimer);
                    resetTimer = null;
                }
            });
            
            document.getElementById('reset-next-2').addEventListener('click', async function() {
                // Obter o código digitado
                const code1 = document.getElementById('code-1').value;
                const code2 = document.getElementById('code-2').value;
                const code3 = document.getElementById('code-3').value;
                const code4 = document.getElementById('code-4').value;
                const code5 = document.getElementById('code-5').value;
                const code6 = document.getElementById('code-6').value;
                
                const code = code1 + code2 + code3 + code4 + code5 + code6;
                
                if (code.length !== 6) {
                    document.getElementById('reset-message-2').textContent = "Por favor, digite o código completo de 6 dígitos.";
                    return;
                }
                
                // Verificar o código
                const messageElement = document.getElementById('reset-message-2');
                messageElement.textContent = "Verificando código...";
                
                const isValid = await verifyResetCode(resetEmail, code);
                
                if (!isValid) {
                    messageElement.textContent = "Código inválido ou expirado. Por favor, tente novamente.";
                    return;
                }
                
                // Código válido, avançar para a próxima etapa
                messageElement.textContent = "Código verificado com sucesso!";
                messageElement.className = "reset-message success";
                
                // Parar o timer
                if (resetTimer) {
                    clearInterval(resetTimer);
                    resetTimer = null;
                }
                
                // Avançar para a próxima etapa após um breve delay
                setTimeout(() => {
                    showResetPasswordContainer(3);
                }, 1000);
            });
            
            document.getElementById('reset-back-3').addEventListener('click', function() {
                showResetPasswordContainer(2);
                
                // Reiniciar o timer
                startResetCodeTimer();
            });
            
            document.getElementById('reset-finish').addEventListener('click', async function() {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const messageElement = document.getElementById('reset-message-3');
                
                if (!newPassword || !confirmPassword) {
                    messageElement.textContent = "Por favor, preencha todos os campos.";
                    return;
                }
                
                if (newPassword.length < 6) {
                    messageElement.textContent = "A senha deve ter pelo menos 6 caracteres.";
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    messageElement.textContent = "As senhas não coincidem. Por favor, tente novamente.";
                    return;
                }
                
                // Atualizar a senha
                messageElement.textContent = "Atualizando senha...";
                
                try {
                    // Em um cenário real, você usaria a API de redefinição de senha do Supabase
                    // Para fins de demonstração, vamos apenas simular o sucesso
                    
                    // Simular um pequeno atraso
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    messageElement.textContent = "Senha atualizada com sucesso!";
                    messageElement.className = "reset-message success";
                    
                    // Fechar o container de recuperação de senha após um breve delay
                    setTimeout(() => {
                        hideResetPasswordContainer();
                        
                        // Se o usuário estiver logado, fazer logout para que ele faça login novamente com a nova senha
                        if (currentUser) {
                            logOut();
                        }
                    }, 2000);
                } catch (error) {
                    console.error("Erro ao atualizar senha:", error);
                    messageElement.textContent = "Erro ao atualizar senha. Por favor, tente novamente.";
                }
            });
            
            // Event listener para o link "Reenviar código"
            document.getElementById('resend-code').addEventListener('click', async function(e) {
                e.preventDefault();
                
                if (!resetEmail) {
                    document.getElementById('reset-message-2').textContent = "Erro ao reenviar código. Por favor, volte e tente novamente.";
                    return;
                }
                
                const messageElement = document.getElementById('reset-message-2');
                
                // Verificar se já foi enviado um código nos últimos 5 minutos
                const { data, error } = await supabaseClient
                    .from('reset_codes')
                    .select('*')
                    .eq('email', resetEmail)
                    .eq('used', false)
                    .gt('expires_at', new Date().toISOString())
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                if (data && data.length > 0 && resetTimer) {
                    messageElement.textContent = "Você já tem um código válido. Por favor, verifique seu email.";
                    return;
                }
                
                // Iniciar a escuta de eventos de criação de código
                await listenForResetCodeCreation(resetEmail);
                
                // Gerar e salvar um novo código
                messageElement.textContent = "Localizando cadastro...";
                
                // Simular um pequeno atraso para mostrar a mensagem de "Localizando cadastro..."
                setTimeout(async () => {
                    // Mostrar mensagem de "Cadastro localizado"
                    messageElement.textContent = "Cadastro localizado";
                    messageElement.className = "reset-message success";
                    
                    // Simular um pequeno atraso antes de prosseguir
                    setTimeout(async () => {
                        messageElement.textContent = "Gerando novo código...";
                        messageElement.className = "reset-message";
                        
                        const requestSent = await requestResetCode(resetEmail);
                        
                        if (!requestSent) {
                            messageElement.textContent = "Erro ao solicitar código de recuperação. Por favor, tente novamente.";
                            return;
                        }
                        
                        // Limpar os campos de código
                        document.querySelectorAll('.code-digit').forEach(input => {
                            input.value = '';
                        });
                        
                        // Focar no primeiro campo
                        document.getElementById('code-1').focus();
                        
                        // A partir daqui, o listener configurado em listenForResetCodeCreation
                        // irá atualizar a interface quando o código for criado
                    }, 1000); // Aguardar 1 segundo após mostrar "Cadastro localizado"
                }, 1000); // Aguardar 1 segundo para simular a busca
            });
            
            // Event listeners para os campos de código
            document.querySelectorAll('.code-digit').forEach((input, index) => {
                // Ao digitar, avançar para o próximo campo
                input.addEventListener('input', function() {
                    if (this.value.length === 1) {
                        // Avançar para o próximo campo
                        const nextInput = document.getElementById(`code-${index + 2}`);
                        if (nextInput) {
                            nextInput.focus();
                        }
                    }
                });
                
                // Ao pressionar backspace em um campo vazio, voltar para o campo anterior
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value.length === 0) {
                        // Voltar para o campo anterior
                        const prevInput = document.getElementById(`code-${index}`);
                        if (prevInput) {
                            prevInput.focus();
                        }
                    }
                });
            });

            // Adicionar event listeners para botões do jogo
            document.getElementById('avancar').onclick = function() {
                indiceFrase++;
                if (indiceFrase >= frases.length) {
                    alert("Parabéns! Você completou todas as frases!");
                    indiceFrase = 0;
                    acertos = 0;
                    progresso = 0;
                    atualizarPlacar();
                    atualizarProgresso();
                }
                fraseAtual = frases[indiceFrase];
                palavrasEmbaralhadas = embaralharPalavras(fraseAtual.texto);
                palavrasClicadas = [];
                fraseAcertada = false;
                criarPalavras();
                atualizarFrase();
                document.getElementById('avancar').style.display = 'none';
                reproduzirTrechoAtual();
                
                // Save progress to Supabase after advancing
                if (currentUser && currentLessonName) {
                    salvarProgressoDoServidor(currentLessonName, indiceFrase, acertos);
                }
            };
            
            document.getElementById('desistir').onclick = function() {
                if (!fraseAtual) return;
                
                palavrasClicadas = fraseAtual.texto.split(' ');
                atualizarFrase();
                
                Object.keys(palavraElementos).forEach(palavra => {
                    if (fraseAtual.texto.split(' ').includes(palavra)) {
                        palavraElementos[palavra].classList.add('acertada');
                    }
                });
                
                if (!fraseAcertada) {
                    progresso++;
                    atualizarProgresso();
                }
                
                document.getElementById('avancar').style.display = 'inline-block';
            };
            
            document.getElementById('repetir').onclick = function() {
                reproduzirTrechoAtual();
            };
            
            document.getElementById('lerFrase').onclick = function() {
                lerFraseAtual();
            };
            
            document.getElementById('menu-button').onclick = toggleMenu;
            document.querySelector('.close-button').onclick = toggleMenu;
            
            // Adicionar listener para teclas de atalho
            document.addEventListener('keydown', function(event) {
                // ESC key to close or open the menu
                if (event.key === 'Escape') {
                    // Se o container de recuperação de senha estiver aberto, fechá-lo
                    if (document.getElementById('reset-password-container').style.display === 'flex') {
                        hideResetPasswordContainer();
                        return;
                    }
                    
                    // Se o menu estiver aberto, fechá-lo
                    const menuOverlay = document.getElementById('menu-overlay');
                    if (menuOverlay.classList.contains('active')) {
                        toggleMenu();
                    }
                }
                
                // SPACE key to play/pause the current section
                if (event.code === 'Space' && !event.target.matches('input, textarea')) {
                    event.preventDefault();
                    if (playerReady && videoElement.paused) {
                        reproduzirTrechoAtual();
                    } else {
                        videoElement.pause();
                        pararMonitorTempo();
                    }
                }
                
                // ENTER key to advance when available
                if (event.key === 'Enter') {
                    const avancarBtn = document.getElementById('avancar');
                    if (avancarBtn.style.display !== 'none') {
                        avancarBtn.click();
                    }
                }
            });
            
            // Add event to restore the interface when the video ends
            videoElement.addEventListener('ended', function() {
                pararMonitorTempo();
            });
            
            // Inicializar a aplicação
            initializeMenuButtons();
            checkCurrentUser();
            
            // Mostrar inicialmente a mensagem para selecionar uma lição
            document.getElementById('current-lesson').textContent = "Selecione uma lição no menu";
            
            // Verificar se há algum parâmetro na URL para carregar uma lição específica
            const urlParams = new URLSearchParams(window.location.search);
            const lessonParam = urlParams.get('lesson');
            
            if (lessonParam !== null && !isNaN(lessonParam) && lessons[parseInt(lessonParam)]) {
                // Carregar a lição especificada pelo parâmetro da URL
                loadLesson(parseInt(lessonParam));
            } else {
                // Se não houver parâmetro, abrir o menu automaticamente
                setTimeout(() => {
                    toggleMenu();
                }, 500);
            }
            
            // Função para verificar se um email já existe no Supabase
            async function checkEmailExists(email) {
                try {
                    // Tentar fazer login com um email que sabemos que não existe
                    // Se o erro for "Invalid login credentials", significa que o email existe
                    // Se o erro for outro, como "Email not confirmed", também significa que o email existe
                    const { error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: "senha_temporaria_para_verificacao"
                    });
                    
                    if (error) {
                        // Se o erro for "Invalid login credentials", o email existe mas a senha está errada
                        // Se for "Email not confirmed", o email existe mas não foi confirmado
                        if (error.message.includes("Invalid login credentials") || 
                            error.message.includes("Email not confirmed")) {
                            return true;
                        }
                    }
                    
                    return false;
                } catch (error) {
                    console.error("Erro ao verificar email:", error);
                    return false;
                }
            }
            
            // Functions for user authentication with Supabase
            async function signUp(email, password) {
                try {
                    // Mostrar mensagem de carregamento
                    const authMessage = document.getElementById('auth-message');
                    authMessage.textContent = "Verificando email...";
                    authMessage.className = "auth-message";
                    
                    console.log("Verificando se o email já existe:", email);
                    
                    // Verificar se o email já existe
                    const emailExists = await checkEmailExists(email);
                    
                    if (emailExists) {
                        console.log("Email já existe:", email);
                        authMessage.textContent = "Este email já está registrado. Por favor, use outro email ou tente fazer login.";
                        return false;
                    }
                    
                    // Email não existe, prosseguir com o registro
                    authMessage.textContent = "Registrando...";
                    
                    console.log("Iniciando registro com:", email);
                    
                    // Registrar usuário com Supabase
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            emailRedirectTo: currentUrl // Usar a URL atual para redirecionamento
                        }
                    });
                    
                    if (error) {
                        console.error("Erro durante registro:", error);
                        throw error;
                    }
                    
                    console.log("Registro bem-sucedido:", data);
                    
                    // Mostrar mensagem de sucesso e instruções para confirmar email
                    authMessage.textContent = "Registro realizado com sucesso! Um email de confirmação foi enviado. Por favor, verifique sua caixa de entrada e confirme seu email antes de fazer login.";
                    authMessage.className = "auth-message success";
                    
                    // Não fazer login automático, aguardar confirmação de email
                    return true;
                } catch (error) {
                    console.error("Error signing up:", error);
                    document.getElementById('auth-message').textContent = `Erro ao registrar: ${error.message}`;
                    return false;
                }
            }

            async function logIn(email, password) {
                try {
                    // Mostrar mensagem de carregamento
                    const authMessage = document.getElementById('auth-message');
                    authMessage.textContent = "Localizando cadastro...";
                    authMessage.className = "auth-message";
                    
                    // Simular um pequeno atraso para mostrar a mensagem de "Localizando cadastro..."
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Verificar se o email existe
                    const emailExists = await checkEmailExists(email);
                    
                    if (!emailExists) {
                        authMessage.textContent = "Email não encontrado. Por favor, verifique e tente novamente.";
                        return false;
                    }
                    
                    // Mostrar mensagem de "Cadastro localizado"
                    authMessage.textContent = "Cadastro localizado";
                    authMessage.className = "auth-message success";
                    
                    // Simular um pequeno atraso antes de prosseguir
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Continuar com o login
                    authMessage.textContent = "Entrando...";
                    authMessage.className = "auth-message";
                    
                    console.log("Iniciando login com:", email);
                    
                    // Login com Supabase
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) {
                        console.error("Erro durante login:", error);
                        
                        // Verificar se o erro é de email não confirmado
                        if (error.message.includes("Email not confirmed")) {
                            authMessage.textContent = 
                                "Email não confirmado. Por favor, verifique sua caixa de entrada e clique no link de confirmação antes de fazer login.";
                        } else {
                            authMessage.textContent = `Erro ao entrar: ${error.message}`;
                        }
                        
                        authMessage.className = "auth-message";
                        return false;
                    }
                    
                    console.log("Login bem-sucedido:", data);
                    currentUser = data.user;
                    
                    // Atualizar a interface após login bem-sucedido
                    document.getElementById('auth-container').style.display = 'none';
                    
                    // Limpar mensagem
                    authMessage.textContent = "";
                    
                    return true;
                } catch (error) {
                    console.error("Error logging in:", error);
                    document.getElementById('auth-message').textContent = `Erro ao entrar: ${error.message}`;
                    return false;
                }
            }

            async function logOut() {
                try {
                    // Salvar progresso antes de sair
                    if (currentUser && currentLessonName && indiceFrase > 0) {
                        await salvarProgressoDoServidor(currentLessonName, indiceFrase, acertos);
                    }
                    
                    await supabaseClient.auth.signOut();
                    currentUser = null;
                    
                    // Mostrar tela de login novamente
                    document.getElementById('auth-container').style.display = 'flex';
                    document.getElementById('auth-message').textContent = "";
                    document.getElementById('auth-message').className = "auth-message";
                    
                    // Fechar o menu se estiver aberto
                    const menuOverlay = document.getElementById('menu-overlay');
                    if (menuOverlay.classList.contains('active')) {
                        toggleMenu();
                    }
                } catch (error) {
                    console.error("Error logging out:", error);
                    alert("Erro ao sair: " + error.message);
                }
            }
            
            // Função para gerar um código de recuperação aleatório
            function generateResetCode() {
                // Gerar um código de 6 dígitos
                return Math.floor(100000 + Math.random() * 900000).toString();
            }
            
            // Função para embaralhar palavras
            function embaralharPalavras(texto) {
                if (!texto) return [];
                
                let palavras = texto.split(' ');
                
                // Embaralhar as palavras
                for (let i = palavras.length - 1; i > 0; i--) {
                    let j = Math.floor(Math.random() * (i + 1));
                    let temp = palavras[i];
                    palavras[i] = palavras[j];
                    palavras[j] = temp;
                }
                return palavras;
            }
            
            // Função para criar elementos de palavras
            function criarPalavras() {
                let palavrasDiv = document.getElementById('palavras');
                palavrasDiv.innerHTML = '';
                palavraElementos = {};
                
                if (!palavrasEmbaralhadas || palavrasEmbaralhadas.length === 0) return;
                
                palavrasEmbaralhadas.forEach(palavra => {
                    let palavraDiv = document.createElement('div');
                    palavraDiv.classList.add('palavra');
                    palavraDiv.innerText = palavra;
                    palavraDiv.onclick = () => clicarPalavra(palavra, palavraDiv);
                    palavraElementos[palavra] = palavraDiv;
                    palavrasDiv.appendChild(palavraDiv);
                });
            }
            
            // Função para lidar com o clique em uma palavra
            function clicarPalavra(palavra, elemento) {
                if (!fraseAtual) return;
                
                // Pausar qualquer áudio em reprodução antes de tocar o novo
                pausarAudios();
                
                // Reproduzir a palavra
                const utterance = new SpeechSynthesisUtterance(palavra);
                utterance.lang = detectarIdioma(fraseAtual.texto);
                
                // Configurar flag para controlar áudio
                audioPlaying = true;
                utterance.onend = function() {
                    audioPlaying = false;
                };
                
                speechSynthesis.speak(utterance);
                
                if (elemento.classList.contains('acertada')) {
                    return; // Palavra já foi usada
                }
                
                let fraseSplit = fraseAtual.texto.split(' ');
                if (palavrasClicadas.length < fraseSplit.length && fraseSplit[palavrasClicadas.length] === palavra) {
                    palavrasClicadas.push(palavra);
                    elemento.classList.add('acertada');
                    atualizarFrase();
                    verificarFrase();
                } else {
                    // Adicionamos a classe errada e removemos após 500ms
                    elemento.classList.add('errada');
                    setTimeout(() => {
                        elemento.classList.remove('errada');
                    }, 500);
                }
            }
            
            // Função para pausar todos os áudios        
            function pausarAudios() {
                // Pausar o sintetizador de voz
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    audioPlaying = false;
                }
                
                // Pausar o vídeo se estiver tocando
                if (playerReady && !videoElement.paused) {
                    videoElement.pause();
                }
            }
            
            // Função para detectar o idioma com base no texto
            function detectarIdioma(texto) {
                if (!texto) return 'en-US';
                
                // Esta é uma detecção simples
                if (texto.includes('Aku') || texto.includes('kamu')) {
                    return 'id-ID'; // Indonésio
                } else if (texto.includes('Scheiße')) {
                    return 'de-DE'; // Alemão
                }
                return 'en-US'; // Por padrão, usamos inglês
            }
            
            // Função para atualizar a frase exibida
            function atualizarFrase() {
                let fraseDiv = document.getElementById('frase');
                fraseDiv.innerHTML = '';
                
                // Adicionar as palavras já clicadas com espaço entre elas
                palavrasClicadas.forEach((palavra, index) => {
                    const span = document.createElement('span');
                    span.textContent = palavra;
                    span.classList.add('palavra-na-frase'); // Adiciona classe para estilização
                    fraseDiv.appendChild(span);
                });
            }
            
            // Função para verificar se a frase está completa
            function verificarFrase() {
                if (!fraseAtual) return;
                
                if (palavrasClicadas.join(' ') === fraseAtual.texto) {
                    document.getElementById('avancar').style.display = 'inline-block';
                    if (playerReady && !videoElement.paused) {
                        videoElement.pause();
                    }
                    progresso++;
                    fraseAcertada = true;
                    acertos++;
                    atualizarPlacar();
                    atualizarProgresso();
                }
            }
            
            // Função para ler a frase atual usando o sintetizador de voz
            function lerFraseAtual() {
                if (!fraseAtual) return;
                
                // Pausar qualquer áudio em reprodução
                pausarAudios();
                
                const utterance = new SpeechSynthesisUtterance(fraseAtual.texto);
                utterance.lang = detectarIdioma(fraseAtual.texto);
                
                // Configurar flag para controlar áudio
                audioPlaying = true;
                utterance.onend = function() {
                    audioPlaying = false;
                };
                
                speechSynthesis.speak(utterance);
            }
            
            // Função para atualizar o progresso
            function atualizarProgresso() {
                document.getElementById('progresso').innerText = `Progresso: ${progresso} de ${frases.length}`;
            }
            
            // Função para atualizar o placar
            function atualizarPlacar() {
                document.getElementById('placar').innerText = `Acertos: ${acertos}`;
            }
            
            // Função para reproduzir o trecho do vídeo atual
            function reproduzirTrechoAtual() {
                if (!fraseAtual) return;
                
                // Verificar se o sintetizador de voz está tocando
                if (audioPlaying) {
                    pausarAudios();
                }
                
                if (playerReady) {
                    videoElement.currentTime = fraseAtual.tempoInicio;
                    videoElement.play();
                    iniciarMonitorTempo();
                }
            }
            
            // Função para alternar a exibição do menu
            function toggleMenu() {
                const menuButton = document.getElementById('menu-button');
                const menuOverlay = document.getElementById('menu-overlay');
                
                menuButton.classList.toggle('active');
                menuOverlay.classList.toggle('active');
            }
            
            // Inicializar botões de menu
            function initializeMenuButtons() {
                const menuItemsContainer = document.getElementById('menu-items');
                // Manter os controles de usuário e o título
                const headerContent = menuItemsContainer.querySelector('.menu-header');
                const titleContent = menuItemsContainer.querySelector('.menu-title');
                
                // Limpar apenas a área de botões de lições
                const lessonButtons = menuItemsContainer.querySelectorAll('.lesson-button');
                lessonButtons.forEach(button => button.remove());
                
                // Adicionar botões de lições
                lessons.forEach((lesson, index) => {
                    const button = document.createElement('button');
                    button.textContent = lesson.name;
                    button.classList.add('lesson-button');
                    button.onclick = () => loadLesson(index);
                    menuItemsContainer.appendChild(button);
                });
            }
        });
    </script>    
</body>
</html>
